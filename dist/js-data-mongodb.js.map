{"version":3,"file":"js-data-mongodb.js","sources":["../src/index.js"],"sourcesContent":["import {MongoClient} from 'mongodb'\nimport {ObjectID} from 'bson'\nimport {utils} from 'js-data'\nimport Adapter from 'js-data-adapter'\nimport {\n  reserved,\n  Response\n} from 'js-data-adapter'\nimport underscore from 'mout/string/underscore'\nimport unique from 'mout/array/unique'\n\nconst {\n  addHiddenPropsToTarget,\n  classCallCheck,\n  extend,\n  fillIn,\n  forEachRelation,\n  forOwn,\n  get,\n  isArray,\n  isObject,\n  isString,\n  isUndefined,\n  omit,\n  plainCopy,\n  resolve\n} = utils\n\nconst withoutRelations = function (mapper, props) {\n  return omit(props, mapper.relationFields || [])\n}\n\nconst DEFAULTS = {\n  /**\n   * Convert ObjectIDs to strings when pulling records out of the database.\n   *\n   * @name MongoDBAdapter#translateId\n   * @type {boolean}\n   * @default true\n   */\n  translateId: true,\n\n  /**\n   * MongoDB URI.\n   *\n   * @name MongoDBAdapter#uri\n   * @type {string}\n   * @default mongodb://localhost:27017\n   */\n  uri: 'mongodb://localhost:27017'\n}\n\nconst FIND_OPTS_DEFAULTS = {}\nconst FIND_ONE_OPTS_DEFAULTS = {}\nconst INSERT_OPTS_DEFAULTS = {}\nconst INSERT_MANY_OPTS_DEFAULTS = {}\nconst UPDATE_OPTS_DEFAULTS = {}\nconst REMOVE_OPTS_DEFAULTS = {}\n\n/**\n * MongoDBAdapter class.\n *\n * @example\n * // Use Container instead of DataStore on the server\n * import {Container} from 'js-data'\n * import MongoDBAdapter from 'js-data-mongodb'\n *\n * // Create a store to hold your Mappers\n * const store = new Container({\n *   mapperDefaults: {\n *     // MongoDB uses \"_id\" as the primary key\n *     idAttribute: '_id'\n *   }\n * })\n *\n * // Create an instance of MongoDBAdapter with default settings\n * const adapter = new MongoDBAdapter()\n *\n * // Mappers in \"store\" will use the MongoDB adapter by default\n * store.registerAdapter('mongodb', adapter, { default: true })\n *\n * // Create a Mapper that maps to a \"user\" collection\n * store.defineMapper('user')\n *\n * @class MongoDBAdapter\n * @param {Object} [opts] Configuration opts.\n * @param {boolean} [opts.debug=false] Whether to log debugging information.\n * @param {Object} [opts.findOpts] Options to pass to collection#find.\n * @param {Object} [opts.findOneOpts] Options to pass to collection#findOne.\n * @param {Object} [opts.insertOpts] Options to pass to collection#insert.\n * @param {Object} [opts.insertManyOpts] Options to pass to\n * collection#insertMany.\n * @param {boolean} [opts.raw=false] Whether to return detailed result objects\n * instead of just record data.\n * @param {Object} [opts.removeOpts] Options to pass to collection#remove.\n * @param {boolean} [opts.translateId=true] Convert ObjectIDs to strings when\n * pulling records out of the database.\n * @param {Object} [opts.updateOpts] Options to pass to collection#update.\n * @param {string} [opts.uri=\"mongodb://localhost:27017\"] MongoDB URI.\n */\nexport default function MongoDBAdapter (opts) {\n  const self = this\n  classCallCheck(self, MongoDBAdapter)\n  opts || (opts = {})\n  if (isString(opts)) {\n    opts = { uri: opts }\n  }\n  fillIn(opts, DEFAULTS)\n  Adapter.call(self, opts)\n\n  /**\n   * Default options to pass to collection#find.\n   *\n   * @name MongoDBAdapter#findOpts\n   * @type {Object}\n   * @default {}\n   */\n  self.findOpts || (self.findOpts = {})\n  fillIn(self.findOpts, FIND_OPTS_DEFAULTS)\n\n  /**\n   * Default options to pass to collection#findOne.\n   *\n   * @name MongoDBAdapter#findOneOpts\n   * @type {Object}\n   * @default {}\n   */\n  self.findOneOpts || (self.findOneOpts = {})\n  fillIn(self.findOneOpts, FIND_ONE_OPTS_DEFAULTS)\n\n  /**\n   * Default options to pass to collection#insert.\n   *\n   * @name MongoDBAdapter#insertOpts\n   * @type {Object}\n   * @default {}\n   */\n  self.insertOpts || (self.insertOpts = {})\n  fillIn(self.insertOpts, INSERT_OPTS_DEFAULTS)\n\n  /**\n   * Default options to pass to collection#insertMany.\n   *\n   * @name MongoDBAdapter#insertManyOpts\n   * @type {Object}\n   * @default {}\n   */\n  self.insertManyOpts || (self.insertManyOpts = {})\n  fillIn(self.insertManyOpts, INSERT_MANY_OPTS_DEFAULTS)\n\n  /**\n   * Default options to pass to collection#update.\n   *\n   * @name MongoDBAdapter#updateOpts\n   * @type {Object}\n   * @default {}\n   */\n  self.updateOpts || (self.updateOpts = {})\n  fillIn(self.updateOpts, UPDATE_OPTS_DEFAULTS)\n\n  /**\n   * Default options to pass to collection#update.\n   *\n   * @name MongoDBAdapter#removeOpts\n   * @type {Object}\n   * @default {}\n   */\n  self.removeOpts || (self.removeOpts = {})\n  fillIn(self.removeOpts, REMOVE_OPTS_DEFAULTS)\n\n  /**\n   * A Promise that resolves to a reference to the MongoDB client being used by\n   * this adapter.\n   *\n   * @name MongoDBAdapter#client\n   * @type {Object}\n   */\n  self.client = new Promise(function (resolve, reject) {\n    MongoClient.connect(opts.uri, function (err, db) {\n      return err ? reject(err) : resolve(db)\n    })\n  })\n}\n\n// Setup prototype inheritance from Adapter\nMongoDBAdapter.prototype = Object.create(Adapter.prototype, {\n  constructor: {\n    value: MongoDBAdapter,\n    enumerable: false,\n    writable: true,\n    configurable: true\n  }\n})\n\nObject.defineProperty(MongoDBAdapter, '__super__', {\n  configurable: true,\n  value: Adapter\n})\n\n/**\n * Alternative to ES6 class syntax for extending `MongoDBAdapter`.\n *\n * @name MongoDBAdapter.extend\n * @method\n * @param {Object} [instanceProps] Properties that will be added to the\n * prototype of the MongoDBAdapter.\n * @param {Object} [classProps] Properties that will be added as static\n * properties to the MongoDBAdapter itself.\n * @return {Object} MongoDBAdapter of `MongoDBAdapter`.\n */\nMongoDBAdapter.extend = extend\n\naddHiddenPropsToTarget(MongoDBAdapter.prototype, {\n  /**\n   * Translate ObjectIDs to strings.\n   *\n   * @name MongoDBAdapter#_translateId\n   * @method\n   * @return {*}\n   */\n  _translateId (r, opts) {\n    opts || (opts = {})\n    if (this.getOpt('translateId', opts)) {\n      if (isArray(r)) {\n        r.forEach(function (_r) {\n          const __id = _r._id ? _r._id.toString() : _r._id\n          _r._id = typeof __id === 'string' ? __id : _r._id\n        })\n      } else if (isObject(r)) {\n        const __id = r._id ? r._id.toString() : r._id\n        r._id = typeof __id === 'string' ? __id : r._id\n      }\n    }\n    return r\n  },\n\n  /**\n   * Return a Promise that resolves to a reference to the MongoDB client being\n   * used by this adapter.\n   *\n   * Useful when you need to do anything custom with the MongoDB client library.\n   *\n   * @name MongoDBAdapter#getClient\n   * @method\n   * @return {Object} MongoDB client.\n   */\n  getClient () {\n    return this.client\n  },\n\n  /**\n   * Map filtering params in a selection query to MongoDB a filtering object.\n   *\n   * Handles the following:\n   *\n   * - where\n   *   - and bunch of filtering operators\n   *\n   * @name MongoDBAdapter#getQuery\n   * @method\n   * @return {Object}\n   */\n  getQuery (mapper, query) {\n    query = plainCopy(query || {})\n    query.where || (query.where = {})\n\n    forOwn(query, function (config, keyword) {\n      if (reserved.indexOf(keyword) === -1) {\n        if (isObject(config)) {\n          query.where[keyword] = config\n        } else {\n          query.where[keyword] = {\n            '==': config\n          }\n        }\n        delete query[keyword]\n      }\n    })\n\n    let mongoQuery = {}\n\n    if (Object.keys(query.where).length !== 0) {\n      forOwn(query.where, function (criteria, field) {\n        if (!isObject(criteria)) {\n          query.where[field] = {\n            '==': criteria\n          }\n        }\n        forOwn(criteria, function (v, op) {\n          if (op === '==' || op === '===' || op === 'contains') {\n            mongoQuery[field] = v\n          } else if (op === '!=' || op === '!==' || op === 'notContains') {\n            mongoQuery[field] = mongoQuery[field] || {}\n            mongoQuery[field].$ne = v\n          } else if (op === '>') {\n            mongoQuery[field] = mongoQuery[field] || {}\n            mongoQuery[field].$gt = v\n          } else if (op === '>=') {\n            mongoQuery[field] = mongoQuery[field] || {}\n            mongoQuery[field].$gte = v\n          } else if (op === '<') {\n            mongoQuery[field] = mongoQuery[field] || {}\n            mongoQuery[field].$lt = v\n          } else if (op === '<=') {\n            mongoQuery[field] = mongoQuery[field] || {}\n            mongoQuery[field].$lte = v\n          } else if (op === 'in') {\n            mongoQuery[field] = mongoQuery[field] || {}\n            mongoQuery[field].$in = v\n          } else if (op === 'notIn') {\n            mongoQuery[field] = mongoQuery[field] || {}\n            mongoQuery[field].$nin = v\n          } else if (op === '|==' || op === '|===' || op === '|contains') {\n            mongoQuery.$or = mongoQuery.$or || []\n            let orEqQuery = {}\n            orEqQuery[field] = v\n            mongoQuery.$or.push(orEqQuery)\n          } else if (op === '|!=' || op === '|!==' || op === '|notContains') {\n            mongoQuery.$or = mongoQuery.$or || []\n            let orNeQuery = {}\n            orNeQuery[field] = {\n              '$ne': v\n            }\n            mongoQuery.$or.push(orNeQuery)\n          } else if (op === '|>') {\n            mongoQuery.$or = mongoQuery.$or || []\n            let orGtQuery = {}\n            orGtQuery[field] = {\n              '$gt': v\n            }\n            mongoQuery.$or.push(orGtQuery)\n          } else if (op === '|>=') {\n            mongoQuery.$or = mongoQuery.$or || []\n            let orGteQuery = {}\n            orGteQuery[field] = {\n              '$gte': v\n            }\n            mongoQuery.$or.push(orGteQuery)\n          } else if (op === '|<') {\n            mongoQuery.$or = mongoQuery.$or || []\n            let orLtQuery = {}\n            orLtQuery[field] = {\n              '$lt': v\n            }\n            mongoQuery.$or.push(orLtQuery)\n          } else if (op === '|<=') {\n            mongoQuery.$or = mongoQuery.$or || []\n            let orLteQuery = {}\n            orLteQuery[field] = {\n              '$lte': v\n            }\n            mongoQuery.$or.push(orLteQuery)\n          } else if (op === '|in') {\n            mongoQuery.$or = mongoQuery.$or || []\n            let orInQuery = {}\n            orInQuery[field] = {\n              '$in': v\n            }\n            mongoQuery.$or.push(orInQuery)\n          } else if (op === '|notIn') {\n            mongoQuery.$or = mongoQuery.$or || []\n            let orNinQuery = {}\n            orNinQuery[field] = {\n              '$nin': v\n            }\n            mongoQuery.$or.push(orNinQuery)\n          }\n        })\n      })\n    }\n\n    return mongoQuery\n  },\n\n  /**\n   * Map non-filtering params in a selection query to MongoDB query options.\n   *\n   * Handles the following:\n   *\n   * - limit\n   * - skip/offset\n   * - orderBy/sort\n   *\n   * @name MongoDBAdapter#getQueryOptions\n   * @method\n   * @return {Object}\n   */\n  getQueryOptions (mapper, query) {\n    query = plainCopy(query || {})\n    query.orderBy = query.orderBy || query.sort\n    query.skip = query.skip || query.offset\n\n    let queryOptions = {}\n\n    if (query.orderBy) {\n      if (isString(query.orderBy)) {\n        query.orderBy = [\n          [query.orderBy, 'asc']\n        ]\n      }\n      for (var i = 0; i < query.orderBy.length; i++) {\n        if (isString(query.orderBy[i])) {\n          query.orderBy[i] = [query.orderBy[i], 'asc']\n        }\n      }\n      queryOptions.sort = query.orderBy\n    }\n\n    if (query.skip) {\n      queryOptions.skip = +query.skip\n    }\n\n    if (query.limit) {\n      queryOptions.limit = +query.limit\n    }\n\n    return queryOptions\n  },\n\n  /**\n   * Turn an _id into an ObjectID if it isn't already an ObjectID.\n   *\n   * @name MongoDBAdapter#toObjectID\n   * @method\n   * @return {*}\n   */\n  toObjectID (mapper, id) {\n    if (id !== undefined && mapper.idAttribute === '_id' && typeof id === 'string' && ObjectID.isValid(id) && !(id instanceof ObjectID)) {\n      return new ObjectID(id)\n    }\n    return id\n  },\n\n  /**\n   * Return the foreignKey from the given record for the provided relationship.\n   *\n   * @name MongoDBAdapter#makeBelongsToForeignKey\n   * @method\n   * @return {*}\n   */\n  makeBelongsToForeignKey (mapper, def, record) {\n    return this.toObjectID(def.getRelation(), Adapter.prototype.makeBelongsToForeignKey.call(this, mapper, def, record))\n  },\n\n  /**\n   * Retrieve the record with the given primary key.\n   *\n   * @name MongoDBAdapter#find\n   * @method\n   * @param {Object} mapper The mapper.\n   * @param {(string|number)} id Primary key of the record to retrieve.\n   * @param {Object} [opts] Configuration options.\n   * @param {Object} [opts.findOneOpts] Options to pass to collection#findOne.\n   * @param {boolean} [opts.raw=false] Whether to return a more detailed\n   * response object.\n   * @param {string[]} [opts.with=[]] Relations to eager load.\n   * @return {Promise}\n   */\n  find (mapper, id, opts) {\n    const self = this\n    let record, op\n    opts || (opts = {})\n    opts.with || (opts.with = [])\n\n    const findOneOpts = self.getOpt('findOneOpts', opts)\n    findOneOpts.fields || (findOneOpts.fields = {})\n\n    return self.getClient().then(function (client) {\n      // beforeFind lifecycle hook\n      op = opts.op = 'beforeFind'\n      return resolve(self[op](mapper, id, opts)).then(function () {\n        return new Promise(function (resolve, reject) {\n          let mongoQuery = {}\n          mongoQuery[mapper.idAttribute] = self.toObjectID(mapper, id)\n          client.collection(mapper.table || underscore(mapper.name)).findOne(mongoQuery, findOneOpts, function (err, cursor) {\n            return err ? reject(err) : resolve(cursor)\n          })\n        })\n      })\n    }).then(function (_record) {\n      if (!_record) {\n        return\n      }\n      record = _record\n      self._translateId(record, opts)\n      const tasks = []\n\n      forEachRelation(mapper, opts, function (def, __opts) {\n        const relatedMapper = def.getRelation()\n        let task\n\n        if (def.foreignKey && (def.type === 'hasOne' || def.type === 'hasMany')) {\n          if (def.type === 'hasOne') {\n            task = self.loadHasOne(mapper, def, record, __opts)\n          } else {\n            task = self.loadHasMany(mapper, def, record, __opts)\n          }\n        } else if (def.type === 'hasMany' && def.localKeys) {\n          let localKeys = []\n          let itemKeys = get(record, def.localKeys) || []\n          itemKeys = isArray(itemKeys) ? itemKeys : Object.keys(itemKeys)\n          localKeys = localKeys.concat(itemKeys)\n          task = self.findAll(relatedMapper, {\n            where: {\n              [relatedMapper.idAttribute]: {\n                'in': unique(localKeys).filter(function (x) { return x }).map(function (x) { return self.toObjectID(relatedMapper, x) })\n              }\n            }\n          }, __opts).then(function (relatedItems) {\n            def.setLocalField(record, relatedItems)\n          })\n        } else if (def.type === 'hasMany' && def.foreignKeys) {\n          task = self.findAll(relatedMapper, {\n            where: {\n              [def.foreignKeys]: {\n                'contains': self.makeHasManyForeignKeys(mapper, def, record)\n              }\n            }\n          }, __opts).then(function (relatedItems) {\n            def.setLocalField(record, relatedItems)\n          })\n        } else if (def.type === 'belongsTo') {\n          task = self.loadBelongsTo(mapper, def, record, __opts)\n        }\n        if (task) {\n          tasks.push(task)\n        }\n      })\n\n      return Promise.all(tasks)\n    }).then(function () {\n      let response = new Response(record, {}, 'find')\n      response.found = record ? 1 : 0\n      response = self.respond(response, opts)\n\n      // afterFind lifecycle hook\n      op = opts.op = 'afterFind'\n      return resolve(self[op](mapper, id, opts, response)).then(function (_response) {\n        // Allow for re-assignment from lifecycle hook\n        return isUndefined(_response) ? response : _response\n      })\n    })\n  },\n\n  /**\n   * Retrieve the records that match the selection query.\n   *\n   * @name MongoDBAdapter#findAll\n   * @method\n   * @param {Object} mapper The mapper.\n   * @param {Object} query Selection query.\n   * @param {Object} [opts] Configuration options.\n   * @param {Object} [opts.findOpts] Options to pass to collection#find.\n   * @param {boolean} [opts.raw=false] Whether to return a more detailed\n   * response object.\n   * @param {string[]} [opts.with=[]] Relations to eager load.\n   * @return {Promise}\n   */\n  findAll (mapper, query, opts) {\n    const self = this\n    opts || (opts = {})\n    opts.with || (opts.with = [])\n\n    let records = []\n    let op\n    const findOpts = self.getOpt('findOpts', opts)\n    fillIn(findOpts, self.getQueryOptions(mapper, query))\n    findOpts.fields || (findOpts.fields = {})\n    const mongoQuery = self.getQuery(mapper, query)\n\n    return self.getClient().then(function (client) {\n      // beforeFindAll lifecycle hook\n      op = opts.op = 'beforeFindAll'\n      return resolve(self[op](mapper, query, opts)).then(function () {\n        return new Promise(function (resolve, reject) {\n          client.collection(mapper.table || underscore(mapper.name)).find(mongoQuery, findOpts).toArray(function (err, cursor) {\n            return err ? reject(err) : resolve(cursor)\n          })\n        })\n      })\n    }).then(function (_records) {\n      records = _records\n      self._translateId(records, opts)\n      const tasks = []\n      forEachRelation(mapper, opts, function (def, __opts) {\n        const relatedMapper = def.getRelation()\n        let task\n        if (def.foreignKey && (def.type === 'hasOne' || def.type === 'hasMany')) {\n          if (def.type === 'hasMany') {\n            task = self.loadHasMany(mapper, def, records, __opts)\n          } else {\n            task = self.loadHasOne(mapper, def, records, __opts)\n          }\n        } else if (def.type === 'hasMany' && def.localKeys) {\n          let localKeys = []\n          records.forEach(function (item) {\n            let itemKeys = item[def.localKeys] || []\n            itemKeys = isArray(itemKeys) ? itemKeys : Object.keys(itemKeys)\n            localKeys = localKeys.concat(itemKeys)\n          })\n          task = self.findAll(relatedMapper, {\n            where: {\n              [relatedMapper.idAttribute]: {\n                'in': unique(localKeys).filter(function (x) { return x }).map(function (x) { return self.toObjectID(relatedMapper, x) })\n              }\n            }\n          }, __opts).then(function (relatedItems) {\n            records.forEach(function (item) {\n              let attached = []\n              let itemKeys = get(item, def.localKeys) || []\n              itemKeys = isArray(itemKeys) ? itemKeys : Object.keys(itemKeys)\n              relatedItems.forEach(function (relatedItem) {\n                if (itemKeys && itemKeys.indexOf(relatedItem[relatedMapper.idAttribute]) !== -1) {\n                  attached.push(relatedItem)\n                }\n              })\n              def.setLocalField(item, attached)\n            })\n            return relatedItems\n          })\n        } else if (def.type === 'hasMany' && def.foreignKeys) {\n          throw new Error('findAll eager load hasMany foreignKeys not supported!')\n        } else if (def.type === 'belongsTo') {\n          task = self.loadBelongsTo(mapper, def, records, __opts)\n        }\n        if (task) {\n          tasks.push(task)\n        }\n      })\n      return Promise.all(tasks)\n    }).then(function () {\n      records || (records = [])\n      let response = new Response(records, {}, 'findAll')\n      response.found = records.length\n      response = self.respond(response, opts)\n\n      // afterFindAll lifecycle hook\n      op = opts.op = 'afterFindAll'\n      return resolve(self[op](mapper, query, opts, response)).then(function (_response) {\n        // Allow for re-assignment from lifecycle hook\n        return isUndefined(_response) ? response : _response\n      })\n    })\n  },\n\n  /**\n   * Create a new record.\n   *\n   * @name MongoDBAdapter#create\n   * @method\n   * @param {Object} mapper The mapper.\n   * @param {Object} props The record to be created.\n   * @param {Object} [opts] Configuration options.\n   * @param {Object} [opts.insertOpts] Options to pass to collection#insert.\n   * @param {boolean} [opts.raw=false] Whether to return a more detailed\n   * response object.\n   * @return {Promise}\n   */\n  create (mapper, props, opts) {\n    const self = this\n    let op\n    props || (props = {})\n    opts || (opts = {})\n\n    const insertOpts = self.getOpt('insertOpts', opts)\n\n    return self.getClient().then(function (client) {\n      // beforeCreate lifecycle hook\n      op = opts.op = 'beforeCreate'\n      return resolve(self[op](mapper, props, opts)).then(function (_props) {\n        // Allow for re-assignment from lifecycle hook\n        props = isUndefined(_props) ? props : _props\n        _props = withoutRelations(mapper, props)\n        return new Promise(function (resolve, reject) {\n          const collection = client.collection(mapper.table || underscore(mapper.name))\n          const method = collection.insertOne ? 'insertOne' : 'insert'\n          collection[method](_props, insertOpts, function (err, cursor) {\n            return err ? reject(err) : resolve(cursor)\n          })\n        })\n      }).then(function (cursor) {\n        let record\n        let r = cursor.ops ? cursor.ops : cursor\n        self._translateId(r, opts)\n        record = isArray(r) ? r[0] : r\n        cursor.connection = undefined\n        let response = new Response(record, cursor, 'create')\n        response.created = record ? 1 : 0\n        response = self.respond(response, opts)\n\n        // afterCreate lifecycle hook\n        op = opts.op = 'afterCreate'\n        return resolve(self[op](mapper, props, opts, response)).then(function (_response) {\n          // Allow for re-assignment from lifecycle hook\n          return isUndefined(_response) ? response : _response\n        })\n      })\n    })\n  },\n\n  /**\n   * Create multiple records in a single batch.\n   *\n   * @name MongoDBAdapter#createMany\n   * @method\n   * @param {Object} mapper The mapper.\n   * @param {Object} props The records to be created.\n   * @param {Object} [opts] Configuration options.\n   * @param {Object} [opts.insertManyOpts] Options to pass to\n   * collection#insertMany.\n   * @param {boolean} [opts.raw=false] Whether to return a more detailed\n   * response object.\n   * @return {Promise}\n   */\n  createMany (mapper, props, opts) {\n    const self = this\n    let op\n    props || (props = {})\n    opts || (opts = {})\n\n    const insertManyOpts = self.getOpt('insertManyOpts', opts)\n\n    return self.getClient().then(function (client) {\n      // beforeCreateMany lifecycle hook\n      op = opts.op = 'beforeCreateMany'\n      return resolve(self[op](mapper, props, opts)).then(function (_props) {\n        // Allow for re-assignment from lifecycle hook\n        props = isUndefined(_props) ? props : _props\n        _props = props.map(function (record) {\n          return withoutRelations(mapper, record)\n        })\n        return new Promise(function (resolve, reject) {\n          const collection = client.collection(mapper.table || underscore(mapper.name))\n          collection.insertMany(_props, insertManyOpts, function (err, cursor) {\n            return err ? reject(err) : resolve(cursor)\n          })\n        })\n      }).then(function (cursor) {\n        let records = []\n        let r = cursor.ops ? cursor.ops : cursor\n        self._translateId(r, opts)\n        records = r\n        cursor.connection = undefined\n        let response = new Response(records, cursor, 'createMany')\n        response.created = records.length\n        response = self.respond(response, opts)\n\n        // afterCreateMany lifecycle hook\n        op = opts.op = 'afterCreateMany'\n        return resolve(self[op](mapper, props, opts, response)).then(function (_response) {\n          // Allow for re-assignment from lifecycle hook\n          return isUndefined(_response) ? response : _response\n        })\n      })\n    })\n  },\n\n  /**\n   * Destroy the record with the given primary key.\n   *\n   * @name MongoDBAdapter#destroy\n   * @method\n   * @param {Object} mapper The mapper.\n   * @param {(string|number)} id Primary key of the record to destroy.\n   * @param {Object} [opts] Configuration options.\n   * @param {boolean} [opts.raw=false] Whether to return a more detailed\n   * response object.\n   * @param {Object} [opts.removeOpts] Options to pass to collection#remove.\n   * @return {Promise}\n   */\n  destroy (mapper, id, opts) {\n    const self = this\n    let op\n    opts || (opts = {})\n    const removeOpts = self.getOpt('removeOpts', opts)\n\n    return self.getClient().then(function (client) {\n      // beforeDestroy lifecycle hook\n      op = opts.op = 'beforeDestroy'\n      return resolve(self[op](mapper, id, opts)).then(function () {\n        return new Promise(function (resolve, reject) {\n          const mongoQuery = {}\n          mongoQuery[mapper.idAttribute] = self.toObjectID(mapper, id)\n          const collection = client.collection(mapper.table || underscore(mapper.name))\n          collection[collection.deleteOne ? 'deleteOne' : 'remove'](mongoQuery, removeOpts, function (err, cursor) {\n            return err ? reject(err) : resolve(cursor)\n          })\n        })\n      })\n    }).then(function (cursor) {\n      cursor.connection = undefined\n      let response = new Response(undefined, cursor, 'destroy')\n      response = self.respond(response, opts)\n\n      // afterDestroy lifecycle hook\n      op = opts.op = 'afterDestroy'\n      return resolve(self[op](mapper, id, opts, response)).then(function (_response) {\n        // Allow for re-assignment from lifecycle hook\n        return isUndefined(_response) ? response : _response\n      })\n    })\n  },\n\n  /**\n   * Destroy the records that match the selection query.\n   *\n   * @name MongoDBAdapter#destroyAll\n   * @method\n   * @param {Object} mapper the mapper.\n   * @param {Object} [query] Selection query.\n   * @param {Object} [opts] Configuration options.\n   * @param {boolean} [opts.raw=false] Whether to return a more detailed\n   * response object.\n   * @param {Object} [opts.removeOpts] Options to pass to collection#remove.\n   * @return {Promise}\n   */\n  destroyAll (mapper, query, opts) {\n    const self = this\n    let op\n    query || (query = {})\n    opts || (opts = {})\n    const removeOpts = self.getOpt('removeOpts', opts)\n    fillIn(removeOpts, self.getQueryOptions(mapper, query))\n\n    return self.getClient().then(function (client) {\n      // beforeDestroyAll lifecycle hook\n      op = opts.op = 'beforeDestroyAll'\n      return resolve(self[op](mapper, query, opts)).then(function () {\n        const mongoQuery = self.getQuery(mapper, query)\n        return new Promise(function (resolve, reject) {\n          const collection = client.collection(mapper.table || underscore(mapper.name))\n          collection[collection.deleteMany ? 'deleteMany' : 'remove'](mongoQuery, removeOpts, function (err, cursor) {\n            return err ? reject(err) : resolve(cursor)\n          })\n        })\n      })\n    }).then(function (cursor) {\n      cursor.connection = undefined\n      let response = new Response(undefined, cursor, 'destroyAll')\n      response = self.respond(response, opts)\n\n      // afterDestroyAll lifecycle hook\n      op = opts.op = 'afterDestroyAll'\n      return resolve(self[op](mapper, query, opts, response)).then(function (_response) {\n        // Allow for re-assignment from lifecycle hook\n        return isUndefined(_response) ? response : _response\n      })\n    })\n  },\n\n  /**\n   * Apply the given update to the record with the specified primary key.\n   *\n   * @name MongoDBAdapter#update\n   * @method\n   * @param {Object} mapper The mapper.\n   * @param {(string|number)} id The primary key of the record to be updated.\n   * @param {Object} props The update to apply to the record.\n   * @param {Object} [opts] Configuration options.\n   * @param {boolean} [opts.raw=false] Whether to return a more detailed\n   * response object.\n   * @param {Object} [opts.updateOpts] Options to pass to collection#update.\n   * @return {Promise}\n   */\n  update (mapper, id, props, opts) {\n    const self = this\n    props || (props = {})\n    opts || (opts = {})\n    let op\n    const updateOpts = self.getOpt('updateOpts', opts)\n\n    return self.find(mapper, id, { raw: false }).then(function (record) {\n      if (!record) {\n        throw new Error('Not Found')\n      }\n      // beforeUpdate lifecycle hook\n      op = opts.op = 'beforeUpdate'\n      return resolve(self[op](mapper, id, props, opts))\n    }).then(function (_props) {\n      // Allow for re-assignment from lifecycle hook\n      props = isUndefined(_props) ? props : _props\n      _props = withoutRelations(mapper, props)\n      return self.getClient().then(function (client) {\n        return new Promise(function (resolve, reject) {\n          const mongoQuery = {}\n          mongoQuery[mapper.idAttribute] = self.toObjectID(mapper, id)\n          const collection = client.collection(mapper.table || underscore(mapper.name))\n          collection[collection.updateOne ? 'updateOne' : 'update'](mongoQuery, { $set: _props }, updateOpts, function (err, cursor) {\n            return err ? reject(err) : resolve(cursor)\n          })\n        })\n      })\n    }).then(function (cursor) {\n      return self.find(mapper, id, { raw: false }).then(function (record) {\n        cursor.connection = undefined\n        let response = new Response(record, cursor, 'update')\n        response.updated = 1\n        response = self.respond(response, opts)\n\n        // afterUpdate lifecycle hook\n        op = opts.op = 'afterUpdate'\n        return resolve(self[op](mapper, id, props, opts, response)).then(function (_response) {\n          // Allow for re-assignment from lifecycle hook\n          return isUndefined(_response) ? response : _response\n        })\n      })\n    })\n  },\n\n  /**\n   * Apply the given update to all records that match the selection query.\n   *\n   * @name MongoDBAdapter#updateAll\n   * @method\n   * @param {Object} mapper The mapper.\n   * @param {Object} props The update to apply to the selected records.\n   * @param {Object} [query] Selection query.\n   * @param {Object} [opts] Configuration options.\n   * @param {boolean} [opts.raw=false] Whether to return a more detailed\n   * response object.\n   * @param {Object} [opts.updateOpts] Options to pass to collection#update.\n   * @return {Promise}\n   */\n  updateAll (mapper, props, query, opts) {\n    const self = this\n    props || (props = {})\n    query || (query = {})\n    opts || (opts = {})\n    let op, ids\n    const updateOpts = self.getOpt('updateOpts', opts)\n    updateOpts.multi = true\n\n    return self.getClient().then(function (client) {\n      const queryOptions = self.getQueryOptions(mapper, query)\n      const mongoQuery = self.getQuery(mapper, query)\n\n      // beforeUpdateAll lifecycle hook\n      op = opts.op = 'beforeUpdateAll'\n      return resolve(self[op](mapper, props, query, opts)).then(function (_props) {\n        // Allow for re-assignment from lifecycle hook\n        props = isUndefined(_props) ? props : _props\n        _props = withoutRelations(mapper, props)\n        queryOptions.$set = _props\n        return self.findAll(mapper, query, { raw: false })\n      }).then(function (records) {\n        ids = records.map(function (record) {\n          return self.toObjectID(mapper, record[mapper.idAttribute])\n        })\n\n        return new Promise(function (resolve, reject) {\n          const collection = client.collection(mapper.table || underscore(mapper.name))\n          collection[collection.updateMany ? 'updateMany' : 'update'](mongoQuery, queryOptions, updateOpts, function (err, cursor) {\n            return err ? reject(err) : resolve(cursor)\n          })\n        })\n      }).then(function (cursor) {\n        const query = {}\n        query[mapper.idAttribute] = {\n          'in': ids\n        }\n        return self.findAll(mapper, query, { raw: false }).then(function (records) {\n          cursor.connection = undefined\n          let response = new Response(records, cursor, 'update')\n          response.updated = records.length\n          response = self.respond(response, opts)\n\n          // afterUpdateAll lifecycle hook\n          op = opts.op = 'afterUpdateAll'\n          return resolve(self[op](mapper, props, query, opts, response)).then(function (_response) {\n            // Allow for re-assignment from lifecycle hook\n            return isUndefined(_response) ? response : _response\n          })\n        })\n      })\n    })\n  },\n\n  /**\n   * Not supported.\n   *\n   * @name MongoDBAdapter#updateMany\n   * @method\n   */\n  updateMany () {\n    throw new Error('not supported!')\n  }\n})\n"],"names":["utils","Adapter","reserved","ObjectID","Response"],"mappings":"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"}